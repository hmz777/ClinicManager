@using ClinicProject.Client.Helpers
@using ClinicProject.Client.Models.CRUD
@using ClinicProject.Client.Services
@using ClinicProject.Shared.Attributes
@using ClinicProject.Shared.DTOs
@using System
@using ClinicProject.Shared.Models.Error
@using ClinicProject.Shared.Models.Patient
@using System.ComponentModel.DataAnnotations
@using System.Reflection
@typeparam T where T : DTOBase

<MudPaper Class="py-4 px-4 mb-5">
    <MudGrid>
        <MudItem xs="12">
            <MudText Typo="Typo.h6">Filters</MudText>
        </MudItem>
        <MudItem xs="6">
            <MudPaper Elevation="0">
                <MudTextField Label="Search Patients" T="string" ValueChanged="@(s=> OnSearch(s))" Variant="Variant.Outlined" Adornment="Adornment.End"
                              AdornmentIcon="@Icons.Material.Outlined.Search" AdornmentColor="Color.Primary" IconSize="Size.Medium"></MudTextField>
            </MudPaper>
        </MudItem>
        <MudItem xs="6">
            <MudPaper Class="d-flex" Elevation="0">
                <MudDatePicker Class="mr-2" Variant="Variant.Outlined" Label="From Date" @bind-Date="DateFrom" DateFormat="dd/MM/yyyy" />
                <MudDatePicker Variant="Variant.Outlined" Label="To Date" @bind-Date="DateTo" DateFormat="dd/MM/yyyy" />
            </MudPaper>
            <MudPaper Elevation="0" Class="mt-2">
                <MudButton StartIcon="@Icons.Material.Outlined.DateRange" Variant="Variant.Filled" Color="Color.Primary" OnClick="FilterByDate">Filter by date</MudButton>
                <MudButton StartIcon="@Icons.Material.Outlined.ClearAll" Variant="Variant.Filled" Color="Color.Error" OnClick="ClearDateFilter">Clear</MudButton>
            </MudPaper>
        </MudItem>
        <MudItem xs="12" Class="py-2">
            <MudDivider />
        </MudItem>
        <MudItem xs="12">
            <MudPaper Elevation="0">
                <MudButtonGroup OverrideStyles="false" Class="mr-2">
                    <MudButton StartIcon="@Icons.Material.Outlined.Add" Variant="Variant.Filled" Color="Color.Primary" OnClick="OnAddPatientBatchPart">Add Patient</MudButton>
                    <MudButton StartIcon="@Icons.Material.Outlined.Delete" Disabled="@(!CanDelete)" Variant="Variant.Filled" Color="Color.Error" OnClick="OnDeleteBatchPart">Delete</MudButton>
                </MudButtonGroup>
                <MudButtonGroup OverrideStyles="false" Class="mr-2">
                    <MudButton StartIcon="@Icons.Material.Outlined.SelectAll" Disabled="@(!CanSelectAll)" Variant="Variant.Filled" Color="Color.Secondary" OnClick="SelectAll">Select All</MudButton>
                    <MudButton StartIcon="@Icons.Material.Outlined.ClearAll" Disabled="@(!CanClearSelection)" Variant="Variant.Filled" Color="Color.Secondary" OnClick="ClearSelection">Clear Selection</MudButton>
                </MudButtonGroup>
                <MudButtonGroup OverrideStyles="false">
                    <MudButton StartIcon="@Icons.Material.Outlined.CheckCircleOutline" Disabled="@(!BatchModel.HasRequests())" Variant="Variant.Filled" Color="Color.Success" OnClick="SaveChanges">Apply</MudButton>
                    <MudButton StartIcon="@Icons.Material.Outlined.Cancel" Disabled="@(!BatchModel.HasRequests())" Variant="Variant.Filled" Color="Color.Error" OnClick="ResetChanges">Cancel changes</MudButton>
                </MudButtonGroup>
            </MudPaper>
        </MudItem>
    </MudGrid>
</MudPaper>

<MudTable @ref="@Table"
          ServerData="@(new Func<TableState, Task<TableData<T>>>(ServerReload))"
          CanCancelEdit="true"
          Hover="true"
          Breakpoint="Breakpoint.LgAndDown"
          LoadingProgressColor="Color.Primary"
          T="T"
          MultiSelection="true"
          FixedHeader="true"
          FixedFooter="true"
          RowEditPreview="ItemBackup"
          RowEditCancel="OnItemEditCancel"
          RowEditCommit="OnBatchPart"
          IsEditRowSwitchingBlocked="true"
          SelectedItems="SelectedItems"
          SelectedItemsChanged="SelectedItemsChanged">
    <ToolBarContent>
        <MudText Typo="Typo.h6">Patients</MudText>
    </ToolBarContent>
    <ColGroup>
        <col />
        <col />
        <col style="width:15%;" />
        <col style="width:20%;" />
        <col style="width:15%;" />
        <col />
        <col />
        <col style="width:15%;" />
        <col />
        <col />
        <col />
        <col />
    </ColGroup>
    <HeaderContent>
        @foreach (var property in PropertyAttributes)
        {
            if (property.Value.Item2 != null)
            {
                if (property.Value.Item2.DataField != DataField.Navigation)
                {
                    <MudTh><MudTableSortLabel T="T" SortLabel="@(property.Key.Name)">@property.Value.Item1.Name</MudTableSortLabel></MudTh>
                }
                else
                {
                    <MudTh>@property.Value.Item1.Name</MudTh>
                }
            }
        }
    </HeaderContent>
    <RowTemplate>
        @foreach (var property in PropertyAttributes)
        {
            if (property.Value.Item2 != null)
            {
                if (property.Value.Item2.DataField != DataField.Navigation)
                {
                    if (property.Key.PropertyType == typeof(DateTime))
                    {
                        <MudTd DataLabel="@(property.Key.Name)">@context.DateValues[property.Key.Name]?.ToString("dd/MM/yyyy")</MudTd>
                    }
                    else
                    {
                        <MudTd DataLabel="@(property.Key.Name)">@property.Key.GetValue(context)</MudTd>
                    }
                }
                else
                {
                    <MudTd DataLabel="@(property.Key.Name)">
                        <MudButton Size="Size.Small" Variant="Variant.Outlined" Color="Color.Primary">View</MudButton>
                    </MudTd>
                }
            }
        }
    </RowTemplate>
    <RowEditingTemplate>
        @foreach (var property in PropertyAttributes)
        {
            if (property.Value.Item2 != null)
            {
                if (property.Value.Item2.Editable)
                {
                    switch (property.Value.Item2.DataField)
                    {
                        case DataField.Text:
                            <MudTd>
                                <MudTextField Label="@(property.Value.Item1.Name)"
                          @bind-Value="@(context.StringValues[property.Key.Name])" Required />
                            </MudTd>
                            break;
                        case DataField.MultiLineText:
                            <MudTd>
                                <MudTextField Label="@(property.Value.Item1.Name)"
                          Lines="3"
                          @bind-Value="@(context.StringValues[property.Key.Name])" Required />
                            </MudTd>
                            break;
                        case DataField.Currency:
                        case DataField.Number:
                            <MudTd>
                                <MudNumericField Label="@(property.Value.Item1.Name)"
                             @bind-Value="@(context.IntValues[property.Key.Name])" Required />
                            </MudTd>
                            break;
                        case DataField.PhoneNumber:
                            <MudTd>
                                <MudTextField Label="@(property.Value.Item1.Name)"
                          Mask="@(new PatternMask("000000000000000"))"
                          @bind-Value="@(context.StringValues[property.Key.Name])" Required />
                            </MudTd>
                            break;
                        case DataField.DateTime:
                            <MudTd>
                                <MudDatePicker Label="@(property.Value.Item1.Name)"
                           DateFormat="dd/MM/yyyy"
                           @bind-Date="@(context.DateValues[property.Key.Name])" Required />
                            </MudTd>
                            break;
                        case DataField.Enum:
                            <MudTd>
                                <MudSelect @bind-Value="@(context.ObjectValues[property.Key.Name])" Required>
                                    @foreach (var value in Enum.GetValues(property.Key.PropertyType))
                                    {
                                          <MudSelectItem Value="@value">@value.ToString()</MudSelectItem>
                                    }
                                </MudSelect>
                            </MudTd>
                            break;
                        default:
                            break;
                    }
                }
                else if (property.Value.Item2.EditPreview)
                {
                    if (property.Key.PropertyType == typeof(DateTime))
                    {
                        <MudTd DataLabel="@(property.Key.Name)">@context.DateValues[property.Key.Name]?.ToString("dd/MM/yyyy")</MudTd>
                    }
                    else
                    {
                        <MudTd DataLabel="@(property.Key.Name)">@property.Key.GetValue(context)</MudTd>
                    }
                }
            }
        }
    </RowEditingTemplate>
    <NoRecordsContent>
        <MudText> No matching records found </MudText>
    </NoRecordsContent>
    <LoadingContent>
        <MudText> Loading...</MudText>
    </LoadingContent>
    <PagerContent>
        <MudTablePager />
    </PagerContent>
</MudTable>